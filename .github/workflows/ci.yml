name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´çš„ä»£ç è´¨é‡æ£€æŸ¥
    - cron: '0 2 * * *'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Download dependencies
      run: go mod download
      
    - name: Install quality tools
      run: |
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
        go install github.com/fzipp/gocyclo/cmd/gocyclo@latest
        go install golang.org/x/tools/cmd/goimports@latest
        
    - name: Run code formatting check
      run: |
        # æ£€æŸ¥ä»£ç æ ¼å¼
        if [ "$(gofmt -l . | wc -l)" -gt 0 ]; then
          echo "ä»¥ä¸‹æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–:"
          gofmt -l .
          exit 1
        fi
        
        # æ£€æŸ¥importæ ¼å¼
        if [ "$(goimports -l . | wc -l)" -gt 0 ]; then
          echo "ä»¥ä¸‹æ–‡ä»¶éœ€è¦importæ ¼å¼åŒ–:"
          goimports -l .
          exit 1
        fi
        
    - name: Run tests
      run: go test -v ./...
      
    - name: Run tests with coverage
      run: |
        go test -v -coverprofile=coverage.out ./...
        go tool cover -html=coverage.out -o coverage.html
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella
        
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
        
    - name: Install quality tools
      run: |
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
        go install github.com/fzipp/gocyclo/cmd/gocyclo@latest
        
    - name: Run golangci-lint
      run: |
        golangci-lint run --config .golangci.yml --out-format github-actions
        
    - name: Run security scan
      run: |
        gosec -conf configs/gosec.json -fmt json -out reports/gosec-report.json ./...
        gosec -conf configs/gosec.json ./...
        
    - name: Run complexity check
      run: |
        mkdir -p reports
        gocyclo -over 10 . > reports/gocyclo-report.txt || true
        echo "å¤æ‚åº¦æ£€æŸ¥å®Œæˆï¼ŒæŠ¥å‘Šå·²ç”Ÿæˆ"
        if [ -s reports/gocyclo-report.txt ]; then
          echo "å‘ç°é«˜å¤æ‚åº¦å‡½æ•°:"
          cat reports/gocyclo-report.txt
          # æ£€æŸ¥æ˜¯å¦æœ‰å¤æ‚åº¦è¶…è¿‡15çš„å‡½æ•°ï¼ˆCIå¤±è´¥é˜ˆå€¼ï¼‰
          if gocyclo -over 15 . | grep -q .; then
            echo "é”™è¯¯: å‘ç°å¤æ‚åº¦è¶…è¿‡15çš„å‡½æ•°ï¼Œè¯·é‡æ„"
            exit 1
          fi
        fi
        
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
        
    - name: Build application
      run: |
        mkdir -p bin
        go build -v -o bin/app ./main.go
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: bin/
        
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
        
    - name: Install gosec
      run: go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
      
    - name: Create reports directory
      run: mkdir -p reports
      
    - name: Run Gosec Security Scanner
      run: |
        gosec -conf configs/gosec.json -fmt json -out reports/gosec-report.json ./...
        gosec -conf configs/gosec.json ./...
        
    - name: Upload security report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: reports/gosec-report.json
        
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/ycg-cloud:latest
          ${{ secrets.DOCKER_USERNAME }}/ycg-cloud:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
  quality:
    name: Code Quality Report
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
        
    - name: Install quality tools
      run: |
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
        go install github.com/fzipp/gocyclo/cmd/gocyclo@latest
        go install golang.org/x/tools/cmd/goimports@latest
        
    - name: Create reports directory
      run: mkdir -p reports
      
    - name: Run comprehensive quality checks
      run: |
        echo "=== ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š ===" > reports/quality-summary.txt
        echo "æ£€æŸ¥æ—¶é—´: $(date)" >> reports/quality-summary.txt
        echo "" >> reports/quality-summary.txt
        
        # ä»£ç æ ¼å¼æ£€æŸ¥
        echo "1. ä»£ç æ ¼å¼æ£€æŸ¥" >> reports/quality-summary.txt
        if [ "$(gofmt -l . | wc -l)" -gt 0 ]; then
          echo "   âŒ å‘ç°æ ¼å¼é—®é¢˜:" >> reports/quality-summary.txt
          gofmt -l . >> reports/quality-summary.txt
        else
          echo "   âœ… ä»£ç æ ¼å¼æ­£ç¡®" >> reports/quality-summary.txt
        fi
        echo "" >> reports/quality-summary.txt
        
        # Importæ ¼å¼æ£€æŸ¥
        echo "2. Importæ ¼å¼æ£€æŸ¥" >> reports/quality-summary.txt
        if [ "$(goimports -l . | wc -l)" -gt 0 ]; then
          echo "   âŒ å‘ç°importé—®é¢˜:" >> reports/quality-summary.txt
          goimports -l . >> reports/quality-summary.txt
        else
          echo "   âœ… Importæ ¼å¼æ­£ç¡®" >> reports/quality-summary.txt
        fi
        echo "" >> reports/quality-summary.txt
        
        # Lintæ£€æŸ¥
        echo "3. Lintæ£€æŸ¥" >> reports/quality-summary.txt
        if golangci-lint run --config .golangci.yml --out-format line-number > reports/golangci-lint.txt 2>&1; then
          echo "   âœ… æ— Linté—®é¢˜" >> reports/quality-summary.txt
        else
          echo "   âŒ å‘ç°Linté—®é¢˜ï¼Œè¯¦è§golangci-lint.txt" >> reports/quality-summary.txt
        fi
        echo "" >> reports/quality-summary.txt
        
        # å®‰å…¨æ£€æŸ¥
        echo "4. å®‰å…¨æ£€æŸ¥" >> reports/quality-summary.txt
        if gosec -conf configs/gosec.json -fmt json -out reports/gosec-report.json ./... 2>/dev/null; then
          issues=$(jq '.Stats.found // 0' reports/gosec-report.json 2>/dev/null || echo "0")
          if [ "$issues" = "0" ]; then
            echo "   âœ… æ— å®‰å…¨é—®é¢˜" >> reports/quality-summary.txt
          else
            echo "   âŒ å‘ç° $issues ä¸ªå®‰å…¨é—®é¢˜ï¼Œè¯¦è§gosec-report.json" >> reports/quality-summary.txt
          fi
        else
          echo "   âš ï¸  å®‰å…¨æ£€æŸ¥æ‰§è¡Œå¤±è´¥" >> reports/quality-summary.txt
        fi
        echo "" >> reports/quality-summary.txt
        
        # å¤æ‚åº¦æ£€æŸ¥
        echo "5. å¤æ‚åº¦æ£€æŸ¥" >> reports/quality-summary.txt
        if gocyclo -over 10 . > reports/gocyclo-report.txt 2>/dev/null; then
          if [ -s reports/gocyclo-report.txt ]; then
            count=$(wc -l < reports/gocyclo-report.txt)
            echo "   âš ï¸  å‘ç° $count ä¸ªé«˜å¤æ‚åº¦å‡½æ•° (>10)ï¼Œè¯¦è§gocyclo-report.txt" >> reports/quality-summary.txt
            
            # æ£€æŸ¥æé«˜å¤æ‚åº¦
            if gocyclo -over 15 . > reports/gocyclo-critical.txt 2>/dev/null && [ -s reports/gocyclo-critical.txt ]; then
              critical_count=$(wc -l < reports/gocyclo-critical.txt)
              echo "   âŒ å‘ç° $critical_count ä¸ªæé«˜å¤æ‚åº¦å‡½æ•° (>15)ï¼Œéœ€è¦ç«‹å³é‡æ„" >> reports/quality-summary.txt
            fi
          else
            echo "   âœ… æ‰€æœ‰å‡½æ•°å¤æ‚åº¦åˆç† (â‰¤10)" >> reports/quality-summary.txt
          fi
        else
          echo "   âœ… æ‰€æœ‰å‡½æ•°å¤æ‚åº¦åˆç† (â‰¤10)" >> reports/quality-summary.txt
        fi
        echo "" >> reports/quality-summary.txt
        
        # æµ‹è¯•è¦†ç›–ç‡
        echo "6. æµ‹è¯•è¦†ç›–ç‡" >> reports/quality-summary.txt
        if go test -coverprofile=coverage.out ./... > /dev/null 2>&1; then
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "   ğŸ“Š æµ‹è¯•è¦†ç›–ç‡: $coverage" >> reports/quality-summary.txt
        else
          echo "   âš ï¸  æ— æ³•è·å–æµ‹è¯•è¦†ç›–ç‡" >> reports/quality-summary.txt
        fi
        echo "" >> reports/quality-summary.txt
        
        echo "=== æ£€æŸ¥å®Œæˆ ===" >> reports/quality-summary.txt
        
        # æ˜¾ç¤ºæ‘˜è¦
        cat reports/quality-summary.txt
        
    - name: Upload quality reports
      uses: actions/upload-artifact@v3
      with:
        name: quality-reports
        path: |
          reports/
          coverage.out
          coverage.html
        retention-days: 30
        
    - name: Comment PR with quality report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            const report = fs.readFileSync('reports/quality-summary.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š\n\n```\n' + report + '\n```'
            });
          } catch (error) {
            console.log('æ— æ³•è¯»å–è´¨é‡æŠ¥å‘Šæ–‡ä»¶:', error.message);
          }